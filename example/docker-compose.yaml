version: "3.9"
services:
  httpbin:
    image: mccutchen/go-httpbin:v2.15.0@sha256:24528cf5229d0b70065ac27e6c9e4d96f5452a84a3ce4433e56573c18d96827a
    environment:
      - MAX_BODY_SIZE=15728640 # 15 MiB
    command: [ "/bin/go-httpbin", "-port", "8081" ]
    ports:
      - "8081:8081"

  coraza-spoa:
    restart: unless-stopped
    build:
      context: ..
      dockerfile: ./example/Dockerfile
    ports:
      - "9000:9000"

  haproxy:
    restart: unless-stopped
    image: haproxy:3.1-alpine@sha256:1b9a695f1e50d69fbc9d2cc5b124210a8124cfc9f354deedab2ff16955a9d3e4
    ports: [ "8080:80", "8443:443", "8082:8082"]
    depends_on:
      - httpbin
    links:
      - "coraza-spoa:coraza-spoa"
      - "httpbin:httpbin"
    volumes:
      - type: bind
        source: ./haproxy/
        target: /usr/local/etc/haproxy
    environment:
      - BACKEND_HOST=httpbin:8081
      - CORAZA_SPOA_HOST=coraza-spoa